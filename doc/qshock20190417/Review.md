形式的仕様記述やってみた感想
============================

感想
-----

* CSPやTLA+で仕様書いてみたけど、期待していたことのうち成功したものも失敗したものあった。
    * 間違いや考慮漏れにより気づきやすくなる => YesでもNoでもある
    * コンパクトに記述出来て全容の把握が更に容易になる => Yes
    * 記述時間は慣れていれば早く済む => 自然言語と比べるならYes

* その他の気づき
    * ○: 何を作るべきか、ソレがバグかどうかすぐに判断出来た
    * ○: 実装時の手戻りを事前に防げたと感じる時が何度かあった
    * ○: 割り込みや短くない間プロジェクトから離れた時のコンテキスト復帰コスト低減した
    * ○: 網羅的かつ機械的なテストケース作成が出来た
    * ○: モデルと一緒にテストケースも書いて検査出来る（どんなイベント列を受理するかだけでなく、どんなイベントは拒否するべきかも書かなければならない）
    * ×: そもそも最初の見積りの材料として仕様を使う機会がなかった
    * ×: 実装時やテスト時に仕様の問題(漏れ、曖昧さ、間違い)に気付いて変更や手戻りが発生した
    * ×: チーム全員に浸透させることが出来なかった


形式的仕様記述の難しさ
------------------------

* そもそもモデルに表れない要素は見落としやすい
    * 非機能要求が漏れる(結果的に耐久や安定性や動作環境関係の評価やテストが後回しになる)
    * 異常系のイベントが漏れる(数のオーバーフロー、計算・記憶・通信リソースの枯渇、通信やライブラリやハードの異常)

* モデルに書いてある問題に気付けない
    * 実装してみて初めて「あれ？この入力どっからとってくるの？仕様破綻してない？」とかに気づく
    * 使ってみて初めて「危ない」とか「使いづらい」とかに気づくことが多い

* 例え形式的に書いても、ソレが自分のイメージと一致している訳ではない(プログラムに対するバグと同じ)
    * モデルやそれに対するテスト(検査やvalidation)の正確さや漏れのなさの担保は開発者のレビューだけ(見落とす)
    * TLA+の場合、不変条件/事前条件/事後条件が緩かったり不適切だったりすることもチラホラあった
    * TLA+の場合、状態は変数の集合でしかなく、そのままだと人に優しくない。状態の集合に名前をつけて管理するといった工夫は必要だった

* そもそもシステムのモデリングは難しい
    * 何を捨象し、何を抽象すればいいのか？
        * 目的の1つはイメージを正しく伝えること
        * 頭の中におさまる程度の複雑さ(1000〜2000行程度??)
        * 手間を惜しんで記述しやすいように近似してしたり、表現することを諦めたりすると、後々に問題を引き起こすこともあった(例えば、ある要素Aとある要素Bの間には関係があるのに、それが表現されていなくて危険な機能を実装してしまったとか)
    * Open vs Close
        * システムの境界がソフトの境界と一致する訳ではない
        * 電気やハードの状態や環境まで表現するべき場合もある
        * 基本的にはソフトから見た各種センサのイベントを時相論理で記述して外部の振るまいを表現する方法をとってる
    * 時間の扱い方
        * そもそも時刻を直接扱わないように記述して非機能で書く(テストケースの記述はコメントを使ってモデルで表現出来ない点について述べる)
        * 明示的にdeltaを刻んだり、各イベントに時刻を埋め込んで振る舞いを書く(刻み方には注意しないと状態爆発する)
        * 絶対時刻 vs 相対時刻
    * 手続き的に振る舞いを書くと実装とあんまり変わらずダブルメンテ状態になる
        * 振る舞い(状態のリスト)としてどうなっていけないかを記述することはなかな大変。
        * 手続き的に書くほうが簡単に思えてしまう場合が多々ある。(Alloyとかはそれを許してくれない)


実際にTLA+書いてみたメンバの意見
---------

* (AlloyやCSPの知識があったので)学習コストは大きいという印象はない。
* 仕様を考える普段の思考が手続き的なので、CSPMのほうが書きやすいと感じる。
* (おそらく状態爆発が原因で)モデル検査が現実的でないのはツラい。正しく記述できている自信がないから。
* ただ、TLA+で仕様を書いて、それを(将来の自分を含む)誰かに伝えるのが目的であれば、トレース(イベントの発生順序)のAccept/Rejectだけチェックできれば十分だろうと感じる。
* 実装が仕様を満たしているかとても確認しやすい。日本語の仕様書でよくある曖昧さがないのがうれしい。
* 日本語で書かれた仕様書は読みたくならないが、TLA+で書かれた仕様書は読みたくなる。興味や好奇心をそそられる。
* TLA+による仕様書をお客さんに提出しているが、読まれているかどうか心配。


