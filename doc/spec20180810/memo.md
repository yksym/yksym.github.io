別に形式的に仕様を書いたっていいじゃない
======================================

社内説明(説得)用資料の焼き直しを晒す。


仕様とは何か？
-------------

ここではシンプルにシステム利用者から観測される振る舞い、あるいはそれらに関する制約を仕様と呼び、仕様について記述した文書を仕様書と呼びます。

SW業界では、XX要求、要件、XX仕様、XX設計、実装という言葉をよく耳にします。
それらの具体的な定義は組織や人によって様々ですが、規格や知識体系は存在しています。
個人的に洗練されてると感じているのはSWEBOK[[http://swebokwiki.org/]]です。
この第一、ニ章を読むだけで、要求、機能要求、非機能要求、仕様(SRS)、設計、verification & validation 等についての定義や雰囲気が分かるかと思います。


仕様書は誰が何に使うの？
----------------------

ざっと思いつく範囲で挙げておきます。

* 開発者が妥当性検証(システムが対象としている問題を解決できるかのチェック)の入力としても利用する
* 開発者が設計・実装・テストの入力として利用する
* 開発者が仕様の拡張・変更の入力として利用する
* QAがテストケースを作成する為に利用する
* QAが見つかった不具合らしき挙動がバグかどうかの切り分けに利用する
* 取扱説明書（マニュアル)作成の入力として利用する


実装前に仕様を書くメリットは？
--------------------

Karl E. Wiegers の"ソフトウェア要求"という本の第一章では何故仕様を書くのかについて分かりやすく解説してくれています。
個人的には以下の３つがビジネス面において最も重要なメリットと言えると思います。

1. 開発工数の短縮
   * 作るべきものについて、開発者と顧客の間で合意ができていれば、無駄な機能を作る可能性は減ります
   * 実装の前に仕様の間違いに気付ければ手戻りが少なくなります(実際この種の不具合は多くの割合を占めるというデータも"ソフトウェア要求"で述べられてます)
   * 開発期間は長く、記憶も劣化します。仕様書は、適切に書けば、優れた外部記憶として利用出来ます(抽象度が高い記述なので、ソースコードを読むより簡単に全容を把握出来ることが期待できます)

2. 見積り精度の向上
   * 記述することで何を作るのかが明確になってくると、具体的にやらなきゃいけない作業も見えてきます
   * 頭の整理、考慮漏れを防ぐプロトタイピング的な効果があります(本来のプロトタイピングは要素技術を評価したり、課題を探ったり、デモを目的としたもの)
   * 仕様変更時においても、修正範囲がどこまで広がるかチェックしやすい(もちろんきちんとコードを見ることも重要です)

3. 顧客満足度の向上
   * 何を作ればいいかを考える時は、誰のどの問題を解決しないといけないか、どうやって検証するのかも自然と考えることになる
   * 品質向上: 開発者もQAは少なくとも書いてある仕様を満たしているか、未定義な振る舞いがないかを確認しようとする


何故自然言語で仕様を記述したくないのか？
---------------------------

自然言語による記述にもメリットとデメリットがあります。

* 自然言語で仕様を記述するメリット
    * 多くの人が読み書き出来る
* 自然言語で仕様を記述するデメリット
    * 複数人で記述する場合、口調や名前の統一やらが大変(チェックも大変)
    * あるモノに対して皆が好き勝手名前をつけ始めると検索すらまともに出来なくなる
    * 意味が一つに定まらない場合もあれば、行間を読まないといけない場合もある
    * 抽象化し辛くて、ボイラープレートが多くなり、ボリュームが大きくなる傾向がある
    * なんとなく書けて、なんとなく読めて、なんとなく理解した気になってしまい、間違いに気付き辛い(意味を正しく把握するには結局頭の中でモデルを作る作業が必要)
    * 文法以外は機械チェックがし辛い
    * 概要やイメージをより正確かつ簡潔に伝える為に結局図やUMLで補足することが多い
    * 言い回しや表現方法について悩み始めると時間があっという間に溶ける
    * 絶望的辛さ（個人の感想)

これらのデメリットのせいで、仕様書が適切にメンテされなくなり、実装を暗黙的な仕様と見做してしまうケースを何度か見た経験があります。


何故形式的仕様を記述するのか？
-------------------------

仕様の一部でも形式的に書いてその正しさをある程度機械的にチェック出来れば、自然言語記述のデメリットを軽減し、前々節で挙げた3つのメリットの効果をさらに高めることが出来ます。

* 形式的に仕様を記述するメリット
    * 間違いや考慮漏れにより気づきやすくなる
        * 物事を理解する良い方法の１つはソレを模したモデルを作ること
        * モデル検査も行うとさらに色々な間違いに気付ける
    * コンパクトに記述出来て全容の把握が更に容易になる
    * 記述時間は記述言語に慣れていれば自然言語よりも早く済む。ただしモデル化や考慮漏れに気付くことで考える時間は増えます（が、トータルで見れば工数短縮になっていると私は感じる)
    * 苦難の中に楽しみを見いだせる（個人の感想)
* 形式的に仕様を記述するデメリット
    * ツールや記述言語がマイナーで読める人が少ない
    * 学習コストがかかる(とはいえ、運用次第で程度は変わる。あと自然言語を学ぶよりは楽）

請負の場合、顧客にそのまま出すことは考えていません。


検討したモデル記述用ツールの雑な紹介(※個人の感想)
------------------------------------

### Alloy

* 集合と関係を使って記述する
* 小スコープ仮説
* 仕様記述に使っている人も実際にいる。自分も使おうとしたのだが、プロジェクトがぽしゃって結局お蔵入り
* 良い点
    * 関係で記述すると手続きとは別の頭を使って楽しい
* 残念な点
    * 状態マシンを記述したい場合、時刻という概念を自分で記述しないとない
    * 四則演算が扱い辛い（古い記憶なので具体例は忘れた）

### CSP(FDR4)

* イベントの発生順序をプロセス式という形で表現することで振るまいを記述し、詳細化関係を検査出来る
* 良い点
    * イベントの発生順序という観点では直感的かつ楽にかける
    * １つのプロセスに着目して記述出来る
    * FDRはTimedも扱えるらしい(使ったことない)
    * 型がある。直和型もある。タプルや集合やシーケンスもある。
    * 発生しうるイベントをツリー状に探索出来る機能が便利(SPINの対話的シミュレーター相当)
    * 状態遷移テストしやすい(イベントの列がそのままテストケースとして使える)
* 残念な点
    * プロセス式とっつき辛い？
    * レコード型がない
    * 検査する場合小さい有限集合に落としこむ必要がある
    * グローバルな状態の参照・操作が書きづらい(自分の脚を打つ行為でもある)
        * 状態はプロセス毎に引数でたらい回しする必要がある
        * 割り込み演算子でその情報は失われる
        * メモリプロセスみたいなもの用意して、そこと通信するとかしないといけない
    * 並行合成は頭の負荷が高い（検査ツール必須)
    * 商用は有料(仕方なくPrimalSpecとかいうツール作った)
    * 有料ツールだと他にもPATやSyncStitchというのがある。LISPアレルギーがなければSyncStitch使ってたと思う

### TLA+

* 状態とアクション(状態マシンでいうイベント)を使って記述する。
* 良い点
    * 状態遷移モデル知ってる人だったら読めるしとっつきやすい
    * CSPと比べて状態が直接扱えて人間の目レビューはしやすい
    * 実装の書き方次第では仕様との対応付けがしやすい
    * カバレッジ機能が素晴らしい
    * イベントが不活性であるバグを検知出来る
    * livenessとか書ける
    * 状態遷移テストしやすい(イベントの列がそのままテストケースとして使える)
* 残念な点
    * 事前条件だけ見ても、イベントの流れが見えない（AとBというイベントの間にBが起こりうるかどうかは検査しないと分かりづらい)
    * アクションの合成という演算はあるが、Until や Next 演算子はない
    * 型がない。不変条件として集合の包含関係で記述して検査時チェック出来るが、何度も実行してエラー出さないといけない。そもそもエラーメッセージ読んだだけで何が問題か分からない場合が結構ある。
    * CSPと比べて対話的シミュレーターがないので、自分で見落としに気づくか適切なassertionを用意しないといけない



### 候補から外したもの

* VDM++
    * 詳しく知らない。陰形式な表現使うと動かせないというような話を聞いたのでやめておいた記憶がある

* SPIN
    * Promela(アクターモデルなC言語的なヤツ)で手続き的に記述
    * プロトコル仕様とか検査するのに使うが、仕様としては書きづらい気がしたので外した
    * ガードを使った非決定性は扱える(が、陰形式な表現は出来ない)
    * CUIあるし、機能も豊富(LTLとか対話シミュレーションとか)


まとめ
-------------

* 形式的に仕様を書くことは楽しいし、会社的にもメリットあるし、新しい知見がきっと得られます。一緒にやりましょう!
* 正直、ある程度の規模のソフトで品質を保って開発を行う場合、私は形式的に書かれた仕様がないと開発出来る自信が全くないので、お願いだから書かせて下さい。あと誰かレビューして。

